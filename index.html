<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>10hp studio - Manga Library</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f0f0f0;
            color: #333333;
        }
        .text-green-main { color: #00b300; }
        .text-green-light { color: #33cc33; }
        .glass-card {
            background-color: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .glass-btn {
            background-color: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(10px);
        }
        .font-8bit {
            font-family: 'Press Start 2P', cursive;
        }
        .manga-card-img {
            aspect-ratio: 2/3;
            object-fit: cover;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            position: relative;
        }
        .close-btn {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .panel-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 1rem;
        }
        .panel-card {
            position: relative;
            cursor: move;
            transition: transform 0.2s ease-in-out;
        }
        .panel-card img {
            border-radius: 8px;
            width: 100%;
            height: auto;
            aspect-ratio: 1/1;
            object-fit: cover;
        }
        .richtext-editor {
            min-height: 300px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 1rem;
            background-color: white;
            outline: none;
        }
        .richtext-toolbar button {
            transition: all 0.2s;
        }
        .richtext-toolbar button:hover {
            transform: scale(1.1);
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <!-- Header -->
    <header class="bg-gray-200 p-4 border-b-2 border-green-main shadow-lg">
        <div class="container mx-auto flex flex-col md:flex-row justify-between items-center space-y-4 md:space-y-0">
            <a href="#" id="mainLogo" class="font-8bit font-bold text-gray-900 transition-colors duration-300 hover:text-green-main leading-none">
                <span class="text-2xl">10hp</span><br>
                <span class="text-lg">studio</span>
            </a>
            <div class="flex items-center w-full md:w-auto space-x-2 md:space-x-4">
                <div class="relative w-full md:w-80">
                    <input type="text" id="searchInput" placeholder="Search for manga..."
                        class="w-full pl-10 pr-4 py-2 rounded-full glass-card border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-main">
                    <svg class="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                </div>
                <nav class="hidden md:block">
                    <ul class="flex space-x-4 items-center">
                        <li><a href="#" id="homeLink" class="text-gray-900 hover:text-green-light transition-colors duration-300">Home</a></li>
                        <li><a href="#" id="browseLink" class="text-gray-900 hover:text-green-light transition-colors duration-300">Browse</a></li>
                        <li><button id="publishBtn" class="px-4 py-2 glass-btn text-gray-900 rounded-full font-semibold transition-transform duration-300 hover:scale-105" style="display:none;">Publish</button></li>
                        <li><a href="#" id="profileLink" class="px-4 py-2 glass-btn text-gray-900 rounded-full font-semibold transition-transform duration-300 hover:scale-105" style="display:none;">My Profile</a></li>
                        <li><a href="#" id="loginLink" class="px-4 py-2 glass-btn text-gray-900 rounded-full font-semibold transition-transform duration-300 hover:scale-105">Login</a></li>
                        <li><a href="#" id="registerLink" class="px-4 py-2 glass-btn text-gray-900 rounded-full font-semibold transition-transform duration-300 hover:scale-105">Register</a></li>
                        <li><a href="#" id="logoutLink" class="px-4 py-2 glass-btn text-gray-900 rounded-full font-semibold transition-transform duration-300 hover:scale-105" style="display:none;">Logout</a></li>
                    </ul>
                </nav>
            </div>
        </div>
    </header>

    <!-- Main Content - Home Page -->
    <main id="homePage" class="flex-grow py-8 px-4 flex flex-col items-center justify-center">
        <div class="container mx-auto text-center glass-card p-8 rounded-xl max-w-2xl mb-8">
            <h1 class="text-4xl font-bold mb-4 text-green-main">Welcome to 10hp studio!</h1>
            <p class="text-lg mb-6">
                Your creative home for self-publishing original comics.
            </p>
            <p class="text-gray-700 leading-relaxed mb-6">
                At 10hp studio, our mission is to provide a user-friendly platform for artists and writers to share their work with the world. We believe that everyone deserves a space to showcase their creativity, whether you're working on a manga, a light novel, a manhwa, or any other form of comic. Our platform empowers you to publish your creations and connect with a global community of readers and fellow creators. Join us in building a new era of independent storytelling.
            </p>
            <button id="exploreBtn" class="px-6 py-3 glass-btn text-gray-900 rounded-full font-semibold transition-transform duration-300 hover:scale-105">
                Explore the Library
            </button>
        </div>

        <!-- Trending Titles Section -->
        <div class="w-full max-w-5xl mb-8">
            <h2 class="text-2xl font-bold text-gray-800 text-center md:text-left mb-4">Trending Titles</h2>
            <div id="trendingMangaGrid" class="flex overflow-x-auto gap-4 p-4 glass-card rounded-xl">
                <!-- Trending manga cards will be injected here -->
            </div>
        </div>
    </main>

    <!-- Main Content - Manga Library -->
    <main id="mangaLibraryPage" class="flex-grow py-8 px-4" style="display: none;">
        <div class="container mx-auto">
            <h1 class="text-4xl font-bold text-center mb-4 text-green-main">Explore Our Manga Library</h1>
            <p id="userIdDisplay" class="text-center text-sm mb-8 text-gray-500"></p>

            <!-- Manga Grid -->
            <div id="mangaGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-6">
                <!-- Manga cards will be injected here by JavaScript -->
                <div id="loading" class="col-span-full text-center text-xl text-gray-500">
                    <p>Loading manga titles...</p>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Main Content - Publish Studio -->
    <main id="publishStudioPage" class="flex-grow py-8 px-4" style="display: none;">
        <div class="container mx-auto max-w-4xl">
            <h1 class="text-4xl font-bold text-center mb-6 text-green-main">Begin your creative journey</h1>
            
            <form id="publishForm" class="glass-card p-6 rounded-xl space-y-6">
                <!-- Content Type Selection -->
                <div class="flex flex-col md:flex-row items-center justify-center space-y-4 md:space-y-0 md:space-x-4 mb-6">
                    <button type="button" id="mangaModeBtn" class="w-full md:w-1/2 py-3 px-6 rounded-xl font-bold text-white transition-colors duration-300" style="background-color: #00b300;">
                        Manga / Comic
                    </button>
                    <button type="button" id="lightNovelModeBtn" class="w-full md:w-1/2 py-3 px-6 rounded-xl font-bold text-gray-900 bg-gray-300 hover:bg-gray-400 transition-colors duration-300">
                        Light Novel
                    </button>
                </div>

                <!-- Common Form Fields -->
                <div class="space-y-4">
                    <div>
                        <label for="mangaTitle" class="block text-sm font-semibold text-gray-700">Title</label>
                        <input type="text" id="mangaTitle" name="mangaTitle" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-main focus:ring-green-main">
                    </div>
                    <div>
                        <label for="mangaAuthor" class="block text-sm font-semibold text-gray-700">Author</label>
                        <input type="text" id="mangaAuthor" name="mangaAuthor" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-main focus:ring-green-main">
                    </div>
                    <div>
                        <label for="coverUpload" class="block text-sm font-semibold text-gray-700">Cover Image (JPG, PNG)</label>
                        <input type="file" id="coverUpload" name="coverUpload" accept="image/png, image/jpeg" class="mt-1 block w-full text-gray-700 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-main file:text-white hover:file:bg-green-light">
                        <p class="mt-2 text-xs text-gray-500">Maximum file size: 10 MB</p>
                    </div>
                    <div>
                        <label for="mangaSynopsis" class="block text-sm font-semibold text-gray-700">Synopsis</label>
                        <textarea id="mangaSynopsis" name="mangaSynopsis" rows="4" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-main focus:ring-green-main"></textarea>
                    </div>
                    <div>
                        <label for="mangaGenre" class="block text-sm font-semibold text-gray-700">Genre</label>
                        <input type="text" id="mangaGenre" name="mangaGenre" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-main focus:ring-green-main" placeholder="e.g., Fantasy, Sci-Fi, Romance">
                    </div>
                    <div>
                        <label for="mangaTags" class="block text-sm font-semibold text-gray-700">Tags</label>
                        <input type="text" id="mangaTags" name="mangaTags" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-main focus:ring-green-main" placeholder="e.g., Adventure, Action, Comedy">
                    </div>
                    <div>
                        <label for="mangaLanguage" class="block text-sm font-semibold text-gray-700">Language</label>
                        <input type="text" id="mangaLanguage" name="mangaLanguage" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-main focus:ring-green-main" placeholder="e.g., English, Japanese">
                    </div>
                    <div>
                        <label for="chapterCount" class="block text-sm font-semibold text-gray-700">Total Chapters</label>
                        <input type="number" id="chapterCount" name="chapterCount" value="1" min="1" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-main focus:ring-green-main">
                    </div>
                </div>

                <!-- Manga/Comic Section -->
                <div id="mangaSection" class="space-y-4">
                    <h2 class="text-xl font-bold text-center mt-6">Manga / Comic Panels</h2>
                    <p class="text-sm text-center text-gray-600">Drag and drop images to rearrange them. Chapter numbers will be auto-generated for you based on the order.</p>
                    <div>
                        <label for="panelsUpload" class="block text-sm font-semibold text-gray-700">Upload Panels (JPG, PNG)</label>
                        <input type="file" id="panelsUpload" name="panelsUpload" multiple accept="image/png, image/jpeg" class="mt-1 block w-full text-gray-700 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-main file:text-white hover:file:bg-green-light">
                    </div>
                    <div id="panelsGrid" class="panel-grid p-4 border border-dashed border-gray-400 rounded-lg min-h-[150px] bg-gray-100">
                        <p class="text-center text-gray-500 col-span-full self-center">Your panels will appear here.</p>
                    </div>
                </div>

                <!-- Light Novel Section -->
                <div id="lightNovelSection" class="space-y-4" style="display: none;">
                    <h2 class="text-xl font-bold text-center mt-6">Light Novel Content</h2>
                    <div class="flex space-x-2 justify-center richtext-toolbar text-gray-700">
                        <button type="button" class="glass-btn px-2 py-1 rounded-lg" onclick="document.execCommand('bold', false, null)"><strong class="text-lg">B</strong></button>
                        <button type="button" class="glass-btn px-2 py-1 rounded-lg" onclick="document.execCommand('italic', false, null)"><em class="text-lg">I</em></button>
                        <button type="button" class="glass-btn px-2 py-1 rounded-lg" onclick="document.execCommand('underline', false, null)"><u class="text-lg">U</u></button>
                        <button type="button" class="glass-btn px-2 py-1 rounded-lg" onclick="document.execCommand('insertUnorderedList', false, null)">UL</button>
                        <button type="button" class="glass-btn px-2 py-1 rounded-lg" onclick="document.execCommand('insertOrderedList', false, null)">OL</button>
                    </div>
                    <div id="novelContent" class="richtext-editor" contenteditable="true">
                        <p>Write or paste your light novel content here...</p>
                    </div>
                    <div>
                        <label for="novelUpload" class="block text-sm font-semibold text-gray-700">Upload from file (.txt, .html)</label>
                        <input type="file" id="novelUpload" name="novelUpload" accept=".txt,.html" class="mt-1 block w-full text-gray-700 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-main file:text-white hover:file:bg-green-light">
                    </div>
                    <p class="text-xs text-gray-500 mt-2">Note: To upload a .docx file, a more complex setup is required. You can copy-paste content from a Word document directly into the editor above.</p>
                </div>
                
                <button type="submit" id="submitBtn"
                    class="w-full py-3 px-4 rounded-md text-white font-bold bg-green-main hover:bg-green-light transition-colors duration-300">
                    Publish Your Work
                </button>
                <p id="formMessage" class="mt-4 text-center"></p>
            </form>
        </div>
    </main>
    
    <!-- Main Content - Author Profile -->
    <main id="authorProfilePage" class="flex-grow py-8 px-4" style="display: none;">
        <div id="profileContainer" class="container mx-auto max-w-4xl">
            <div id="profileBanner" class="w-full h-48 bg-gray-300 rounded-t-xl overflow-hidden relative">
                <img id="profileBannerImage" class="w-full h-full object-cover" src="https://placehold.co/1024x256/E5E7EB/A1A1AA?text=Default+Banner" alt="Profile Banner">
            </div>
            <div class="glass-card p-6 rounded-b-xl -mt-16 relative z-10">
                <div class="flex flex-col md:flex-row items-center md:items-start space-y-4 md:space-y-0 md:space-x-6">
                    <div class="relative w-32 h-32 rounded-full overflow-hidden border-4 border-white shadow-md">
                        <img id="profilePfp" class="w-full h-full object-cover" src="https://placehold.co/128x128/D1D5DB/6B7280?text=PFP" alt="Profile Picture">
                    </div>
                    <div class="flex-1 text-center md:text-left">
                        <h1 id="profileName" class="text-3xl font-bold text-green-main mb-2"></h1>
                        <p id="profileBio" class="text-gray-700 mb-4"></p>
                        <div id="socialLinks" class="flex justify-center md:justify-start space-x-4 mb-4">
                            <!-- Social links will be injected here -->
                        </div>
                        <button id="editProfileBtn" class="px-4 py-2 glass-btn rounded-full font-semibold transition-transform duration-300 hover:scale-105" style="display:none;">Edit Profile</button>
                    </div>
                </div>

                <div class="mt-8">
                    <h2 class="text-2xl font-bold text-green-main mb-4">Published Works</h2>
                    <div id="authorWorksGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-6">
                        <!-- Published works will be injected here -->
                        <div id="noWorksMessage" class="col-span-full text-center text-gray-500">
                            <p>This author has not published any work yet.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modals -->
    <!-- Login Modal -->
    <div id="loginModal" class="modal">
        <div class="modal-content glass-card max-w-md">
            <span class="close-btn" data-modal-id="loginModal">&times;</span>
            <h2 class="text-2xl font-bold text-center text-green-main mb-4">Login</h2>
            <form id="loginForm" class="space-y-4">
                <div>
                    <label for="loginEmail" class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="loginEmail" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-main focus:ring-green-main">
                </div>
                <div>
                    <label for="loginPassword" class="block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="loginPassword" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-main focus:ring-green-main">
                </div>
                <p id="loginMessage" class="text-center text-sm"></p>
                <button type="submit" class="w-full py-2 px-4 rounded-md text-white font-bold bg-green-main hover:bg-green-light transition-colors duration-300">Login</button>
            </form>
        </div>
    </div>
    
    <!-- Register Modal -->
    <div id="registerModal" class="modal">
        <div class="modal-content glass-card max-w-md">
            <span class="close-btn" data-modal-id="registerModal">&times;</span>
            <h2 class="text-2xl font-bold text-center text-green-main mb-4">Register</h2>
            <form id="registerForm" class="space-y-4">
                <div>
                    <label for="registerName" class="block text-sm font-medium text-gray-700">Name</label>
                    <input type="text" id="registerName" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-main focus:ring-green-main">
                </div>
                <div>
                    <label for="registerEmail" class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="registerEmail" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-main focus:ring-green-main">
                </div>
                <div>
                    <label for="registerPassword" class="block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="registerPassword" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-main focus:ring-green-main">
                </div>
                <div class="flex items-center space-x-2">
                    <input type="checkbox" id="captchaCheck" required class="h-4 w-4 text-green-main border-gray-300 rounded">
                    <label for="captchaCheck" class="text-sm font-medium text-gray-700">I am not a robot</label>
                </div>
                <p id="registerMessage" class="text-center text-sm"></p>
                <button type="submit" class="w-full py-2 px-4 rounded-md text-white font-bold bg-green-main hover:bg-green-light transition-colors duration-300">Register</button>
            </form>
        </div>
    </div>

    <!-- Edit Profile Modal -->
    <div id="editProfileModal" class="modal">
        <div class="modal-content glass-card max-w-2xl">
            <span class="close-btn" data-modal-id="editProfileModal">&times;</span>
            <h2 class="text-2xl font-bold text-center text-green-main mb-4">Edit Profile</h2>
            <form id="editProfileForm" class="space-y-4">
                <div>
                    <label for="editPfp" class="block text-sm font-medium text-gray-700">Profile Picture</label>
                    <input type="file" id="editPfp" accept="image/*" class="mt-1 block w-full text-gray-700 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-main file:text-white hover:file:bg-green-light">
                </div>
                <div>
                    <label for="editBanner" class="block text-sm font-medium text-gray-700">Banner Image</label>
                    <input type="file" id="editBanner" accept="image/*" class="mt-1 block w-full text-gray-700 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-main file:text-white hover:file:bg-green-light">
                </div>
                <div>
                    <label for="editBio" class="block text-sm font-medium text-gray-700">Bio</label>
                    <textarea id="editBio" rows="4" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-main focus:ring-green-main"></textarea>
                </div>
                <div>
                    <h3 class="text-lg font-bold mt-4">Social Links</h3>
                    <div id="socialInputs" class="space-y-2">
                        <!-- Social inputs will be dynamically added -->
                        <div class="flex items-center space-x-2">
                            <input type="text" id="social-twitter" placeholder="Twitter URL" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-green-main focus:ring-green-main">
                        </div>
                        <div class="flex items-center space-x-2">
                            <input type="text" id="social-instagram" placeholder="Instagram URL" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-green-main focus:ring-green-main">
                        </div>
                    </div>
                </div>
                <p id="editProfileMessage" class="text-center text-sm mt-4"></p>
                <button type="submit" class="w-full py-2 px-4 rounded-md text-white font-bold bg-green-main hover:bg-green-light transition-colors duration-300">Save Profile</button>
            </form>
            
            <div id="paywallSection" class="mt-8 p-4 bg-gray-100 rounded-lg">
                <h3 class="text-lg font-bold text-center text-gray-700">Unlock Customizations</h3>
                <p class="text-sm text-center text-gray-500 mb-4">Upgrade to a premium account to unlock more profile options!</p>
                <div id="premiumOptions" class="space-y-4" style="display: none;">
                    <div>
                        <label for="customBgUpload" class="block text-sm font-medium text-gray-700">Custom Background</label>
                        <input type="file" id="customBgUpload" accept="image/*" class="mt-1 block w-full text-gray-700 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-main file:text-white hover:file:bg-green-light">
                    </div>
                    <div>
                        <label for="bgColor" class="block text-sm font-medium text-gray-700">Background Color</label>
                        <input type="color" id="bgColor" class="mt-1 block w-full h-10">
                    </div>
                </div>
                <button id="buyPremiumBtn" class="w-full mt-4 py-2 px-4 rounded-md text-white font-bold bg-yellow-500 hover:bg-yellow-600 transition-colors duration-300">Unlock Premium ($5.99)</button>
            </div>
        </div>
    </div>


    <!-- Manga Details Modal -->
    <div id="mangaDetailsModal" class="modal">
        <div class="modal-content glass-card border border-gray-300 max-w-2xl">
            <span class="close-btn" data-modal-id="mangaDetailsModal">&times;</span>
            <div class="flex flex-col md:flex-row gap-6 items-center md:items-start">
                <img id="detailsCover" src="https://placehold.co/300x450" alt="Manga Cover" class="w-48 h-72 rounded-lg shadow-lg">
                <div class="text-left flex-1">
                    <h2 id="detailsTitle" class="text-3xl font-bold text-green-main mb-2"></h2>
                    <p class="text-xl text-gray-700 mb-2">by <a href="#" id="detailsAuthor" class="hover:underline"></a></p>
                    <p id="detailsLanguage" class="text-md text-gray-500 mb-4"></p>
                    <div class="text-sm text-gray-600 space-y-2 mb-4">
                        <p><strong class="font-semibold">Genre:</strong> <span id="detailsGenre"></span></p>
                        <p><strong class="font-semibold">Tags:</strong> <span id="detailsTags"></span></p>
                        <p><strong class="font-semibold">Chapters:</strong> <span id="detailsChapters"></span></p>
                        <p><strong class="font-semibold">Publication Date:</strong> <span id="detailsDate"></span></p>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold mb-2">Synopsis</h3>
                        <p id="detailsSynopsis" class="text-gray-700 leading-relaxed"></p>
                    </div>
                </div>
            </div>
            <div class="mt-6 flex justify-center space-x-4">
                <button id="viewChaptersBtn" class="px-6 py-3 glass-btn rounded-full font-semibold transition-transform duration-300 hover:scale-105">View Chapters</button>
                <button id="readBtn" class="px-6 py-3 glass-btn rounded-full font-semibold transition-transform duration-300 hover:scale-105">Read First Chapter</button>
            </div>
        </div>
    </div>

    <!-- Chapter List Modal -->
    <div id="chapterListModal" class="modal">
        <div class="modal-content glass-card border border-gray-300 max-w-2xl">
            <span class="close-btn" data-modal-id="chapterListModal">&times;</span>
            <h2 id="chapterListTitle" class="text-3xl font-bold text-center text-green-main mb-4">Table of Contents</h2>
            <ul id="chapterList" class="space-y-2 max-h-[70vh] overflow-y-auto">
                <!-- Chapter links will be dynamically added here -->
            </ul>
        </div>
    </div>

    <!-- Content Viewer Modal -->
    <div id="contentViewerModal" class="modal">
        <div class="modal-content glass-card border border-gray-300 max-w-4xl max-h-[90vh] overflow-y-auto">
            <span class="close-btn" data-modal-id="contentViewerModal">&times;</span>
            <h2 id="viewerTitle" class="text-3xl font-bold text-center text-green-main mb-4"></h2>
            <div id="viewerContent" class="space-y-4">
                <!-- Content will be injected here -->
            </div>
        </div>
    </div>
    
    <!-- Footer -->
    <footer class="bg-gray-200 py-6 mt-auto text-center border-t-2 border-green-light">
        <div class="container mx-auto px-4">
            <p class="text-gray-600 text-sm">
                &copy; 2024 Manga Library. All rights reserved.
            </p>
            <div class="mt-2 text-gray-500 text-xs">
                <a href="#" class="hover:text-green-main">Privacy Policy</a> |
                <a href="#" class="hover:text-green-main">Terms of Service</a>
            </div>
        </div>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, setDoc, doc, getDoc, query, where, getDocs, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";
        
        // Firebase Global Variables
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // UI elements
        const pages = ['homePage', 'mangaLibraryPage', 'publishStudioPage', 'authorProfilePage'];
        const elements = {};
        pages.forEach(id => elements[id] = document.getElementById(id));
        ['mainLogo', 'homeLink', 'browseLink', 'publishBtn', 'profileLink', 'loginLink', 'registerLink', 'logoutLink', 'exploreBtn', 'mangaGrid', 'searchInput', 'mangaDetailsModal', 'chapterListModal', 'contentViewerModal', 'loginModal', 'registerModal', 'editProfileModal'].forEach(id => elements[id] = document.getElementById(id));
        document.querySelectorAll('.close-btn').forEach(btn => btn.addEventListener('click', (e) => {
            const modalId = e.target.getAttribute('data-modal-id');
            elements[modalId].style.display = 'none';
        }));

        const publishForm = document.getElementById('publishForm');
        const formMessage = document.getElementById('formMessage');
        const loadingIndicator = document.getElementById('loading');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const mangaModeBtn = document.getElementById('mangaModeBtn');
        const lightNovelModeBtn = document.getElementById('lightNovelModeBtn');
        const mangaSection = document.getElementById('mangaSection');
        const lightNovelSection = document.getElementById('lightNovelSection');
        const panelsUpload = document.getElementById('panelsUpload');
        const panelsGrid = document.getElementById('panelsGrid');
        const novelContent = document.getElementById('novelContent');
        const novelUpload = document.getElementById('novelUpload');
        const viewerTitle = document.getElementById('viewerTitle');
        const viewerContent = document.getElementById('viewerContent');
        const viewChaptersBtn = document.getElementById('viewChaptersBtn');
        const readBtn = document.getElementById('readBtn');
        const chapterList = document.getElementById('chapterList');
        const coverUpload = document.getElementById('coverUpload');
        const loginForm = document.getElementById('loginForm');
        const loginMessage = document.getElementById('loginMessage');
        const registerForm = document.getElementById('registerForm');
        const registerMessage = document.getElementById('registerMessage');
        const editProfileBtn = document.getElementById('editProfileBtn');
        const editProfileForm = document.getElementById('editProfileForm');
        const editProfileMessage = document.getElementById('editProfileMessage');
        const buyPremiumBtn = document.getElementById('buyPremiumBtn');
        const premiumOptions = document.getElementById('premiumOptions');
        const trendingMangaGrid = document.getElementById('trendingMangaGrid');

        let db, auth, storage, currentUserId, currentUsername;
        let currentPublishMode = 'manga'; // Default mode
        let panels = []; // Array to store uploaded panel files
        let currentManga = null; // Store the currently selected manga object

        // Function to toggle between pages
        function showPage(pageId, extraData = null) {
            pages.forEach(id => elements[id].style.display = 'none');
            const pageElement = elements[pageId];
            if (pageElement) {
                pageElement.style.display = 'block';
                if (pageId === 'homePage' || pageId === 'blogPage') {
                    pageElement.style.display = 'flex';
                }
                if (pageId === 'authorProfilePage' && extraData) {
                    displayAuthorProfile(extraData);
                }
            }
        }

        // Set the publish form mode
        function setPublishMode(mode) {
            currentPublishMode = mode;
            if (mode === 'manga') {
                mangaModeBtn.style.backgroundColor = '#00b300';
                mangaModeBtn.style.color = '#fff';
                lightNovelModeBtn.style.backgroundColor = 'rgba(255, 255, 255, 0.3)';
                lightNovelModeBtn.style.color = '#333';
                mangaSection.style.display = 'block';
                lightNovelSection.style.display = 'none';
            } else if (mode === 'light_novel') {
                mangaModeBtn.style.backgroundColor = 'rgba(255, 255, 255, 0.3)';
                lightNovelModeBtn.style.backgroundColor = '#00b300';
                lightNovelModeBtn.style.color = '#fff';
                mangaSection.style.display = 'none';
                lightNovelSection.style.display = 'block';
            }
        }

        // Initialize Firebase
        function initFirebase() {
            try {
                if (Object.keys(firebaseConfig).length === 0) {
                    throw new Error("Firebase config is missing. Cannot initialize.");
                }
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                storage = getStorage(app);
                setLogLevel('debug');
                console.log("Firebase initialized successfully.");
        
                // Sign in the user
                if (initialAuthToken) {
                    signInWithCustomToken(auth, initialAuthToken).then(() => {
                        console.log("Signed in with custom token.");
                    }).catch(error => {
                        console.error("Custom token sign-in failed:", error);
                        signInAnonymously(auth);
                    });
                } else {
                    signInAnonymously(auth);
                }
        
                // Listen for auth state changes
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        userIdDisplay.textContent = `Your User ID: ${currentUserId}`;
                        console.log("User authenticated with UID:", currentUserId);
                        elements['loginLink'].style.display = 'none';
                        elements['registerLink'].style.display = 'none';
                        elements['publishBtn'].style.display = 'block';
                        elements['profileLink'].style.display = 'block';
                        elements['logoutLink'].style.display = 'block';
                        const userProfile = await getUserProfile(currentUserId);
                        currentUsername = userProfile?.name || 'Anonymous';
                        editProfileBtn.style.display = 'block';
        
                    } else {
                        currentUserId = null;
                        currentUsername = 'Anonymous';
                        userIdDisplay.textContent = `Your User ID: Anonymous`;
                        console.log("User is not authenticated.");
                        elements['loginLink'].style.display = 'block';
                        elements['registerLink'].style.display = 'block';
                        elements['publishBtn'].style.display = 'none';
                        elements['profileLink'].style.display = 'none';
                        elements['logoutLink'].style.display = 'none';
                    }
                    fetchManga();
                });
            } catch (e) {
                console.error("Failed to initialize Firebase:", e);
                loadingIndicator.textContent = "Error loading manga titles. Please check console for details.";
            }
        }
        
        async function getUserProfile(userId) {
            if (!db) return null;
            const profileDocRef = doc(db, `artifacts/${appId}/users/${userId}/profile/details`);
            const profileSnap = await getDoc(profileDocRef);
            return profileSnap.exists() ? profileSnap.data() : null;
        }

        // Fetch manga data from Firestore
        function fetchManga() {
            if (!db) {
                console.log("Waiting for Firebase to be ready...");
                loadingIndicator.textContent = "Connecting to the server...";
                return;
            }
            
            loadingIndicator.style.display = 'block';
            const collectionPath = `artifacts/${appId}/public/data/manga`;
            const mangaColRef = collection(db, collectionPath);
            
            // NOTE: The 'Missing or insufficient permissions' error is likely due to your Firestore Security Rules.
            // You need to update your rules to allow read access to the 'manga' collection.
            //
            // Here is an example of the rules you should add to your Firebase console:
            //
            // rules_version = '2';
            // service cloud.firestore {
            //   match /databases/{database}/documents {
            //     match /artifacts/{appId}/public/data/manga/{mangaId} {
            //       allow read; // Allows anyone to read
            //       allow write: if request.auth != null; // Allows authenticated users to write
            //     }
            //   }
            // }

            onSnapshot(mangaColRef, async (querySnapshot) => {
                const mangaData = [];
                // Add a pre-populated demo manga title for the user to try
                const demoManga = {
                    title: 'The Crimson Blade',
                    author: 'Demo Artist',
                    publisherId: 'demo-user-1',
                    cover: 'https://placehold.co/200x300/F22E2E/FFFFFF?text=Demo+Cover',
                    chapters: 1,
                    type: 'manga',
                    synopsis: 'In a world ruled by ancient gods and mythical beasts, a young swordsman named Kael embarks on a quest to avenge his fallen clan. Wielding a legendary crimson blade, he must face off against dark forces and uncover the truth behind his tragic past.',
                    genre: 'Action, Fantasy',
                    tags: 'Adventure, Magic, Swordsmanship',
                    language: 'English',
                    timestamp: new Date(),
                    panels: [
                        'https://placehold.co/500x500/F22E2E/FFFFFF?text=Panel+1',
                        'https://placehold.co/500x500/F22E2E/FFFFFF?text=Panel+2',
                        'https://placehold.co/500x500/F22E2E/FFFFFF?text=Panel+3',
                    ]
                };
                mangaData.push(demoManga);

                const demoNovel = {
                    title: 'Echoes of the Starlight',
                    author: 'Demo Author',
                    publisherId: 'demo-user-2',
                    cover: 'https://placehold.co/200x300/4D82D0/FFFFFF?text=Light+Novel+Cover',
                    chapters: 1,
                    type: 'light_novel',
                    synopsis: 'A lonely astrologue discovers a hidden message in the constellations, leading her on an epic journey to a forgotten celestial city. She must decipher ancient prophecies and confront her own destiny to save the universe from an impending cosmic darkness.',
                    genre: 'Sci-Fi, Romance',
                    tags: 'Space, Adventure, Prophecy',
                    language: 'English',
                    timestamp: new Date(),
                    content: `<p>The first chapter of the saga begins...</p><p>Elara, a young astrologue with a passion for the cosmos, sat hunched over her star charts in the quiet solitude of her observatory. The celestial patterns seemed to whisper secrets only she could hear. One night, a new, vibrant constellation appeared, pulsating with an energy she had never felt before. It was an anomaly, a rogue pattern that defied all known celestial maps.</p><p>As she traced its path, a strange symbol emerged—a key. It unlocked a message, not in words, but in pure light, that spoke of a hidden city among the stars, a place where the light of creation was born. Her heart pounded with a mix of fear and excitement. The cosmos was calling, and she had to answer.</p>`
                };
                mangaData.push(demoNovel);

                querySnapshot.forEach((doc) => {
                    mangaData.push(doc.data());
                });
                
                // Sort the data by title alphabetically
                mangaData.sort((a, b) => a.title.localeCompare(b.title));
                
                renderManga(mangaData);
                renderTrendingManga(mangaData.slice(0, 5)); // Show the first 5 as trending
                loadingIndicator.style.display = 'none';
                console.log("Manga data updated from Firestore.");
            }, (error) => {
                console.error("Error fetching manga data:", error);
                loadingIndicator.textContent = "Error loading manga titles. Please check permissions.";
            });
        }

        // Function to create a manga card element
        function createMangaCard(manga) {
            const card = document.createElement('div');
            card.className = 'glass-card rounded-xl overflow-hidden shadow-lg transition-transform duration-300 hover:scale-105 hover:shadow-2xl cursor-pointer';
            
            const img = document.createElement('img');
            img.src = manga.cover || 'https://placehold.co/200x300/e6e6e6/ffffff?text=No+Cover';
            img.alt = `${manga.title} Cover`;
            img.className = 'w-full manga-card-img';
            img.onerror = () => img.src = 'https://placehold.co/200x300/e6e6e6/ffffff?text=Image+Error';

            const info = document.createElement('div');
            info.className = 'p-4';

            const title = document.createElement('h3');
            title.className = 'text-lg font-semibold truncate text-gray-900';
            title.textContent = manga.title;

            const author = document.createElement('p');
            author.className = 'text-sm text-gray-500 truncate';
            const authorLink = document.createElement('a');
            authorLink.textContent = `by ${manga.author}`;
            authorLink.href = '#';
            authorLink.className = 'hover:underline';
            authorLink.addEventListener('click', (e) => {
                e.preventDefault();
                showPage('authorProfilePage', manga.publisherId);
            });
            author.appendChild(authorLink);
            
            info.appendChild(title);
            info.appendChild(author);
            card.appendChild(img);
            card.appendChild(info);

            card.addEventListener('click', () => {
                showMangaDetailsModal(manga);
            });

            return card;
        }
        
        // Function to render the manga grid
        function renderManga(mangaArray) {
            elements['mangaGrid'].innerHTML = '';
            if (mangaArray.length === 0) {
                elements['mangaGrid'].innerHTML = '<p class="col-span-full text-center text-gray-500">No manga titles found. Be the first to publish one!</p>';
            } else {
                mangaArray.forEach(manga => {
                    const card = createMangaCard(manga);
                    elements['mangaGrid'].appendChild(card);
                });
            }
        }
        
        // Function to render the trending manga list
        function renderTrendingManga(mangaArray) {
            trendingMangaGrid.innerHTML = '';
            mangaArray.forEach(manga => {
                const card = document.createElement('div');
                card.className = 'flex-shrink-0 w-32 glass-card rounded-xl overflow-hidden shadow-lg transition-transform duration-300 hover:scale-105 hover:shadow-2xl cursor-pointer';
                
                const img = document.createElement('img');
                img.src = manga.cover || 'https://placehold.co/200x300';
                img.alt = `${manga.title} Cover`;
                img.className = 'w-full manga-card-img';
                img.onerror = () => img.src = 'https://placehold.co/200x300/e6e6e6/ffffff?text=Image+Error';
                
                card.appendChild(img);
                
                const info = document.createElement('div');
                info.className = 'p-2 text-center';
                const title = document.createElement('h3');
                title.className = 'text-sm font-semibold truncate text-gray-900';
                title.textContent = manga.title;
                info.appendChild(title);
                card.appendChild(info);

                card.addEventListener('click', () => {
                    showMangaDetailsModal(manga);
                });

                trendingMangaGrid.appendChild(card);
            });
        }

        async function displayAuthorProfile(authorId) {
            const profile = await getUserProfile(authorId);
            const profileContainer = document.getElementById('profileContainer');

            if (profileContainer) {
                // Apply premium style if unlocked
                if (profile && profile.isPremium) {
                    profileContainer.style.backgroundColor = profile.bgColor || '';
                    profileContainer.style.backgroundImage = profile.bgUrl ? `url(${profile.bgUrl})` : 'none';
                    profileContainer.style.backgroundSize = 'cover';
                    profileContainer.style.backgroundPosition = 'center';
                } else {
                    profileContainer.style.backgroundColor = '';
                    profileContainer.style.backgroundImage = 'none';
                }
            }

            document.getElementById('profileName').textContent = profile?.name || 'Unknown Author';
            document.getElementById('profileBio').textContent = profile?.bio || 'No bio available.';
            document.getElementById('profilePfp').src = profile?.pfpUrl || 'https://placehold.co/128x128/D1D5DB/6B7280?text=PFP';
            document.getElementById('profileBannerImage').src = profile?.bannerUrl || 'https://placehold.co/1024x256/E5E7EB/A1A1AA?text=Default+Banner';
            
            const socialLinksDiv = document.getElementById('socialLinks');
            socialLinksDiv.innerHTML = '';
            if (profile?.socialLinks) {
                for (const platform in profile.socialLinks) {
                    if (profile.socialLinks[platform]) {
                        const link = document.createElement('a');
                        link.href = profile.socialLinks[platform];
                        link.target = '_blank';
                        link.className = 'text-gray-700 hover:text-green-main transition-colors';
                        link.textContent = platform.charAt(0).toUpperCase() + platform.slice(1);
                        socialLinksDiv.appendChild(link);
                    }
                }
            }

            // Show Edit Profile button only for the logged-in user
            if (currentUserId && currentUserId === authorId) {
                elements['editProfileBtn'].style.display = 'block';
            } else {
                elements['editProfileBtn'].style.display = 'none';
            }

            // Display published works
            const authorWorksGrid = document.getElementById('authorWorksGrid');
            authorWorksGrid.innerHTML = '';
            const noWorksMessage = document.getElementById('noWorksMessage');
            noWorksMessage.style.display = 'none';
            
            const mangaColRef = collection(db, `artifacts/${appId}/public/data/manga`);
            const q = query(mangaColRef, where("publisherId", "==", authorId));
            const querySnapshot = await getDocs(q);
            
            if (querySnapshot.empty) {
                noWorksMessage.style.display = 'block';
            } else {
                querySnapshot.forEach(doc => {
                    const mangaData = doc.data();
                    const card = createMangaCard(mangaData);
                    authorWorksGrid.appendChild(card);
                });
            }
        }
        
        // Modal logic
        function showMangaDetailsModal(manga) {
            currentManga = manga;
            document.getElementById('detailsCover').src = manga.cover || 'https://placehold.co/300x450';
            document.getElementById('detailsTitle').textContent = manga.title;
            const authorLink = document.getElementById('detailsAuthor');
            authorLink.textContent = manga.author;
            authorLink.onclick = (e) => {
                e.preventDefault();
                elements['mangaDetailsModal'].style.display = 'none';
                showPage('authorProfilePage', manga.publisherId);
            };
            document.getElementById('detailsSynopsis').textContent = manga.synopsis || "No synopsis available.";
            document.getElementById('detailsGenre').textContent = manga.genre || "N/A";
            document.getElementById('detailsTags').textContent = manga.tags || "N/A";
            document.getElementById('detailsChapters').textContent = manga.chapters || "N/A";
            document.getElementById('detailsLanguage').textContent = manga.language || "N/A";
            const pubDate = manga.timestamp?.toDate ? manga.timestamp.toDate().toLocaleDateString() : 'N/A';
            document.getElementById('detailsDate').textContent = pubDate;
            elements['mangaDetailsModal'].style.display = 'flex';
        }

        // Other modal and content viewer functions remain the same as previous response

        // Authentication Logic
        elements['loginLink'].addEventListener('click', (e) => { e.preventDefault(); elements['loginModal'].style.display = 'flex'; });
        elements['registerLink'].addEventListener('click', (e) => { e.preventDefault(); elements['registerModal'].style.display = 'flex'; });
        elements['logoutLink'].addEventListener('click', async (e) => {
            e.preventDefault();
            await signOut(auth);
            console.log("User signed out.");
            showPage('homePage');
        });
        elements['profileLink'].addEventListener('click', (e) => {
            e.preventDefault();
            if (currentUserId) {
                showPage('authorProfilePage', currentUserId);
            }
        });
        
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = e.target.loginEmail.value;
            const password = e.target.loginPassword.value;
            loginMessage.textContent = 'Logging in...';
            try {
                await signInWithEmailAndPassword(auth, email, password);
                loginMessage.textContent = 'Login successful!';
                loginMessage.style.color = 'green';
                setTimeout(() => elements['loginModal'].style.display = 'none', 1000);
            } catch (error) {
                loginMessage.textContent = `Error: ${error.message}`;
                loginMessage.style.color = 'red';
                console.error("Login failed:", error);
            }
        });

        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = e.target.registerEmail.value;
            const password = e.target.registerPassword.value;
            const name = e.target.registerName.value;
            registerMessage.textContent = 'Registering...';
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const userId = userCredential.user.uid;
                // Create a basic user profile in Firestore
                // NOTE: To fix the "Missing or insufficient permissions" error for new user profiles,
                // ensure your Firestore Security Rules allow writes to the user's private data path.
                //
                // Example rules for user profiles:
                // match /artifacts/{appId}/users/{userId}/profile/details {
                //   allow read, write: if request.auth != null && request.auth.uid == userId;
                // }
                const profileRef = doc(db, `artifacts/${appId}/users/${userId}/profile/details`);
                await setDoc(profileRef, {
                    name: name,
                    email: email,
                    bio: 'No bio yet.',
                    socialLinks: { twitter: '', instagram: '' },
                    pfpUrl: 'https://placehold.co/128x128/D1D5DB/6B7280?text=PFP',
                    bannerUrl: 'https://placehold.co/1024x256/E5E7EB/A1A1AA?text=Default+Banner',
                    isPremium: false
                });
                registerMessage.textContent = 'Registration successful! You can now log in.';
                registerMessage.style.color = 'green';
                setTimeout(() => elements['registerModal'].style.display = 'none', 2000);
            } catch (error) {
                registerMessage.textContent = `Error: ${error.message}`;
                registerMessage.style.color = 'red';
                console.error("Registration failed:", error);
            }
        });

        editProfileBtn.addEventListener('click', async () => {
            const profile = await getUserProfile(currentUserId);
            if (profile) {
                document.getElementById('editBio').value = profile.bio || '';
                document.getElementById('social-twitter').value = profile.socialLinks?.twitter || '';
                document.getElementById('social-instagram').value = profile.socialLinks?.instagram || '';
                if (profile.isPremium) {
                    buyPremiumBtn.textContent = 'Premium Unlocked';
                    buyPremiumBtn.disabled = true;
                    premiumOptions.style.display = 'block';
                    document.getElementById('bgColor').value = profile.bgColor || '#ffffff';
                } else {
                    buyPremiumBtn.textContent = 'Unlock Premium ($5.99)';
                    buyPremiumBtn.disabled = false;
                    premiumOptions.style.display = 'none';
                }
            }
            elements['editProfileModal'].style.display = 'flex';
        });

        editProfileForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            editProfileMessage.textContent = 'Saving...';
            try {
                const bio = document.getElementById('editBio').value;
                const twitter = document.getElementById('social-twitter').value;
                const instagram = document.getElementById('social-instagram').value;
                const pfpFile = document.getElementById('editPfp').files[0];
                const bannerFile = document.getElementById('editBanner').files[0];
                const customBgFile = document.getElementById('customBgUpload').files[0];
                const bgColor = document.getElementById('bgColor').value;
                
                const profileRef = doc(db, `artifacts/${appId}/users/${currentUserId}/profile/details`);
                const updateData = {
                    bio,
                    socialLinks: { twitter, instagram }
                };

                // Upload and get URL for PFP
                if (pfpFile) {
                    const pfpRef = ref(storage, `user-profiles/${currentUserId}/pfp/${pfpFile.name}`);
                    await uploadBytes(pfpRef, pfpFile);
                    updateData.pfpUrl = await getDownloadURL(pfpRef);
                }
                
                // Upload and get URL for Banner
                if (bannerFile) {
                    const bannerRef = ref(storage, `user-profiles/${currentUserId}/banner/${bannerFile.name}`);
                    await uploadBytes(bannerRef, bannerFile);
                    updateData.bannerUrl = await getDownloadURL(bannerRef);
                }
                
                // Upload and get URL for Custom BG (if premium)
                if (customBgFile && !buyPremiumBtn.disabled) {
                    const customBgRef = ref(storage, `user-profiles/${currentUserId}/custom-bg/${customBgFile.name}`);
                    await uploadBytes(customBgRef, customBgFile);
                    updateData.bgUrl = await getDownloadURL(customBgRef);
                }
                
                if (!buyPremiumBtn.disabled) {
                    updateData.bgColor = bgColor;
                }

                await setDoc(profileRef, updateData, { merge: true });
                editProfileMessage.textContent = 'Profile updated successfully!';
                editProfileMessage.style.color = 'green';
                setTimeout(() => elements['editProfileModal'].style.display = 'none', 1000);
            } catch (error) {
                editProfileMessage.textContent = `Error: ${error.message}`;
                editProfileMessage.style.color = 'red';
                console.error("Profile update failed:", error);
            }
        });
        
        buyPremiumBtn.addEventListener('click', async () => {
            const profileRef = doc(db, `artifacts/${appId}/users/${currentUserId}/profile/details`);
            try {
                await setDoc(profileRef, { isPremium: true }, { merge: true });
                buyPremiumBtn.textContent = 'Premium Unlocked';
                buyPremiumBtn.disabled = true;
                premiumOptions.style.display = 'block';
                editProfileMessage.textContent = 'Premium features unlocked!';
                editProfileMessage.style.color = 'green';
            } catch (error) {
                editProfileMessage.textContent = `Error: ${error.message}`;
                editProfileMessage.style.color = 'red';
            }
        });

        // Other form and navigation logic remains the same
        publishForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!auth.currentUser) {
                formMessage.textContent = "You must be logged in to publish work.";
                formMessage.style.color = "red";
                return;
            }
            
            if (!db || !storage || !currentUserId) {
                formMessage.textContent = "Error: Not connected to the database or not authenticated. Please try refreshing the page.";
                formMessage.style.color = "red";
                return;
            }

            const title = document.getElementById('mangaTitle').value;
            const author = document.getElementById('mangaAuthor').value;
            const synopsis = document.getElementById('mangaSynopsis').value;
            const genre = document.getElementById('mangaGenre').value;
            const tags = document.getElementById('mangaTags').value;
            const language = document.getElementById('mangaLanguage').value;
            const chapters = document.getElementById('chapterCount').value;
            
            const coverFile = coverUpload.files[0];
            const MAX_SIZE_MB = 10;

            if (!title || !author || !synopsis || !genre || !tags || !language || !chapters) {
                formMessage.textContent = "All fields are required.";
                formMessage.style.color = "red";
                return;
            }

            if (coverFile && coverFile.size > MAX_SIZE_MB * 1024 * 1024) {
                formMessage.textContent = `Error: Cover image size exceeds the ${MAX_SIZE_MB}MB limit.`;
                formMessage.style.color = "red";
                return;
            }

            formMessage.textContent = "Publishing...";
            formMessage.style.color = "gray";

            try {
                let coverUrl = 'https://placehold.co/200x300/e6e6e6/ffffff?text=No+Cover';
                if (coverFile) {
                    const storageRef = ref(storage, `manga-covers/${currentUserId}/${Date.now()}-${coverFile.name}`);
                    const uploadTask = await uploadBytes(storageRef, coverFile);
                    coverUrl = await getDownloadURL(uploadTask.ref);
                }

                let docData = {
                    title: title,
                    author: author,
                    publisherId: currentUserId,
                    cover: coverUrl,
                    chapters: parseInt(chapters),
                    synopsis: synopsis,
                    genre: genre,
                    tags: tags,
                    language: language,
                    timestamp: new Date()
                };

                if (currentPublishMode === 'manga') {
                    if (panels.length === 0) {
                        formMessage.textContent = "Please upload at least one manga panel.";
                        formMessage.style.color = "red";
                        return;
                    }
                    
                    const panelUrls = [];
                    for (const panel of panels) {
                        const panelRef = ref(storage, `manga-panels/${currentUserId}/${Date.now()}-${panel.file.name}`);
                        const panelUploadTask = await uploadBytes(panelRef, panel.file);
                        const panelUrl = await getDownloadURL(panelUploadTask.ref);
                        panelUrls.push(panelUrl);
                    }
                    docData.type = 'manga';
                    docData.panels = panelUrls;

                } else if (currentPublishMode === 'light_novel') {
                    const content = novelContent.innerHTML;
                    if (content.trim() === '' || content.trim() === '<p>Write or paste your light novel content here...</p>') {
                        formMessage.textContent = "Please add content for your light novel.";
                        formMessage.style.color = "red";
                        return;
                    }
                    docData.type = 'light_novel';
                    docData.content = content;
                }

                // Add a new document to the 'manga' collection
                const mangaRef = collection(db, `artifacts/${appId}/public/data/manga`);
                await addDoc(mangaRef, docData);

                formMessage.textContent = "Work published successfully!";
                formMessage.style.color = "green";
                publishForm.reset();
                panels = []; // Clear panels after successful submission
                renderPanels();
                novelContent.innerHTML = "<p>Write or paste your light novel content here...</p>";
                setPublishMode('manga'); // Reset to default mode
                showPage('mangaLibraryPage');
            } catch (e) {
                console.error("Error adding document:", e);
                formMessage.textContent = "Failed to publish. Please check console for details.";
                formMessage.style.color = "red";
            }
        });
        
        // Navigation
        elements['mainLogo'].addEventListener('click', (e) => { e.preventDefault(); showPage('homePage'); });
        elements['homeLink'].addEventListener('click', (e) => { e.preventDefault(); showPage('homePage'); });
        elements['browseLink'].addEventListener('click', (e) => { e.preventDefault(); showPage('mangaLibraryPage'); });
        elements['exploreBtn'].addEventListener('click', (e) => { e.preventDefault(); showPage('mangaLibraryPage'); });
        elements['publishBtn'].addEventListener('click', () => { showPage('publishStudioPage'); });
        mangaModeBtn.addEventListener('click', () => setPublishMode('manga'));
        lightNovelModeBtn.addEventListener('click', () => setPublishMode('light_novel'));


        initFirebase();
        setPublishMode('manga');
        
    </script>
</body>
</html>
